import{b as D,j as t}from"./query-vendor-KlcNboas.js";import{c as N,a as x,b as j,F as R}from"./form-vendor--t6BffNT.js";import{e as H,a as I}from"./react-vendor-vqeg7uDR.js";import{Z as P,_ as B,C as b,f as E,g as q,h as C,i as V}from"./index-D-ec5iYs.js";const v=[{value:"saturday",label:"شنبه"},{value:"sunday",label:"یکشنبه"},{value:"monday",label:"دوشنبه"},{value:"tuesday",label:"سه‌شنبه"},{value:"wednesday",label:"چهارشنبه"},{value:"thursday",label:"پنج‌شنبه"},{value:"friday",label:"جمعه"}];function L({clinic:r}){const T=H(),p=D(),{mutateAsync:S}=P(),{mutateAsync:F}=B(),h=I.useRef(null),[u,y]=I.useState(!1),g=!!r?.id,M=N({name:x().required("نام کلینیک الزامی است"),address:x().required("آدرس الزامی است"),phoneNumber:x(),description:x(),latitude:j().nullable().min(-90,"عرض جغرافیایی باید بین -90 تا 90 باشد").max(90,"عرض جغرافیایی باید بین -90 تا 90 باشد"),longitude:j().nullable().min(-180,"طول جغرافیایی باید بین -180 تا 180 باشد").max(180,"طول جغرافیایی باید بین -180 تا 180 باشد"),workingHours:N(),eitaaChatId:x().nullable()}),O=async(e,d)=>{try{const a=new FormData;if(a.append("name",e.name),a.append("address",e.address),a.append("phoneNumber",e.phoneNumber),e.description&&a.append("description",e.description),e.latitude!==null&&e.latitude!==void 0&&!isNaN(e.latitude)&&a.append("latitude",e.latitude.toString()),e.longitude!==null&&e.longitude!==void 0&&!isNaN(e.longitude)&&a.append("longitude",e.longitude.toString()),e.workingHours){const n={};v.forEach(i=>{const c=e.workingHours[i.value]||[];if(c.length>0){const l=c.filter(o=>o.start&&o.end).map(o=>`${o.start}-${o.end}`);n[i.value]=l.length>0?l.join(" & "):null}else n[i.value]=null}),a.append("workingHours",JSON.stringify(n))}const s=e.eitaaChatId||"";console.log("=== FRONTEND DEBUG - eitaaChatId ==="),console.log("values.eitaaChatId:",e.eitaaChatId),console.log("eitaaChatIdValue to send:",s),console.log("isEditMode:",g),a.append("eitaaChatId",s),console.log("=== FormData entries ===");for(const[n,i]of a.entries())console.log(`${n}:`,i);if(console.log("========================"),e.image instanceof File&&a.append("image",e.image),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:122",message:"Before adding removeImage to FormData",data:{removeImage:u,isEditMode:g,hasImageFile:e.image instanceof File},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{}),u&&g&&(a.append("removeImage","true"),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:125",message:"removeImage added to FormData",data:{removeImage:u,isEditMode:g},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{})),g&&r?.id){fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:127",message:"Before updateClinic call",data:{clinicId:r.id,removeImage:u,hasImageFile:a.has("image"),hasRemoveImage:a.has("removeImage")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});let n;try{n=await F({id:r.id,data:a}),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:130",message:"After updateClinic response - SUCCESS",data:{clinicId:r.id,responseImage:n?.data?.clinic?.image,responseImageNull:n?.data?.clinic?.image===null,responseImageUndefined:n?.data?.clinic?.image===void 0,fullResponse:JSON.stringify(n)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{})}catch(i){const c=i;throw fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:155",message:"After updateClinic response - ERROR",data:{clinicId:r.id,error:c?.message,errorResponse:c?.response?.data},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),i}C("کلینیک با موفقیت ویرایش شد"),y(!1),n?.data?.clinic&&(p.setQueryData(["clinic",r.id],n),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:135",message:"Cache updated with response",data:{clinicId:r.id,cachedImage:n?.data?.clinic?.image},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})),await p.invalidateQueries({queryKey:["clinics"],refetchType:"active"}),await p.invalidateQueries({queryKey:["clinic",r.id],refetchType:"active"}),await p.refetchQueries({queryKey:["clinics"]}),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:139",message:"Queries invalidated",data:{clinicId:r.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),T("/admin/clinics-management")}else{await S(a),C("کلینیک با موفقیت ایجاد شد"),d(),h.current&&(h.current.value=""),p.invalidateQueries({queryKey:["clinics"]}),p.invalidateQueries({queryKey:["clinic"]});const n=document.querySelector(".overflow-auto");n?n.scrollTo({top:0,behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})}}catch(a){const s=a?.response?.data?.message||(g?"خطایی در ویرایش کلینیک رخ داد":"خطایی در ایجاد کلینیک رخ داد");V(s)}};return t.jsx(R,{initialValues:{name:r?.name||"",address:r?.address||"",phoneNumber:r?.phoneNumber||"",description:r?.description||"",image:null,latitude:r?.latitude??null,longitude:r?.longitude??null,eitaaChatId:r?.eitaaChatId||null,workingHours:(()=>{const e=r?.workingHours;if(e){const d={};return v.forEach(a=>{const s=e[a.value];if(s==null)d[a.value]=[];else if(typeof s=="string"&&s.trim())if(s.includes(" & ")){const n=s.split(" & ").map(i=>{const[c,l]=i.trim().split("-");return{start:c||"",end:l||""}});d[a.value]=n.filter(i=>i.start&&i.end)}else{const[n,i]=s.split("-");d[a.value]=n&&i?[{start:n.trim(),end:i.trim()}]:[]}else Array.isArray(s)?d[a.value]=s.map(n=>{if(typeof n=="string"){const[i,c]=n.split("-");return{start:i||"",end:c||""}}return n}):d[a.value]=[]}),d}return{}})()},validationSchema:M,onSubmit:async(e,{resetForm:d})=>{await O({name:e.name,address:e.address,phoneNumber:e.phoneNumber,description:e.description,image:e.image,latitude:e.latitude===null||e.latitude===void 0?null:Number(e.latitude),longitude:e.longitude===null||e.longitude===void 0?null:Number(e.longitude),workingHours:e.workingHours,eitaaChatId:e.eitaaChatId||null},d)},children:e=>{const d=r?.image&&!e.values.image&&!u;return t.jsxs("form",{onSubmit:e.handleSubmit,className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ",children:[t.jsx(b,{labelText:"نام کلینیک",placeholder:"نام کلینیک را وارد کنید",className:"bg-white",requiredText:!0,...e.getFieldProps("name"),errorMessage:e.touched.name&&e.errors.name?e.errors.name:null}),t.jsx(b,{labelText:"شماره تماس",placeholder:"شماره تماس را وارد کنید",requiredText:!0,className:"bg-white",...e.getFieldProps("phoneNumber"),inputType:"phone",errorMessage:e.touched.phoneNumber&&e.errors.phoneNumber?e.errors.phoneNumber:null})]}),t.jsx(b,{labelText:"آدرس",placeholder:"آدرس کلینیک را وارد کنید",requiredText:!0,className:"bg-white",...e.getFieldProps("address"),errorMessage:e.touched.address&&e.errors.address?e.errors.address:null}),t.jsx(E,{labelText:"توضیحات",placeholder:"توضیحات کلینیک را وارد کنید",optional:!0,rows:4,className:"bg-white",...e.getFieldProps("description"),errorMessage:e.touched.description&&e.errors.description?e.errors.description:null}),t.jsxs("div",{className:"bg-blue-50 rounded-lg border border-blue-200 p-4",children:[t.jsxs("h6",{className:"text-md font-estedad-semibold text-dark mb-3",children:[t.jsx("i",{className:"fas fa-paper-plane ml-2"}),"تنظیمات ایتا"]}),t.jsx("p",{className:"text-xs text-gray-600 mb-3 font-estedad-light",children:"شناسه کانال/گروه ایتا برای ارسال نوتیفیکیشن نوبت‌های این کلینیک"}),t.jsx(b,{labelText:"شناسه کانال/گروه ایتا",placeholder:"مثال: 1404 یا eitaayar",optional:!0,className:"bg-white",...e.getFieldProps("eitaaChatId"),errorMessage:e.touched.eitaaChatId&&e.errors.eitaaChatId?e.errors.eitaaChatId:null})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-dark font-estedad-lightbold mb-2 mr-4",children:"تصویر کلینیک"}),t.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[t.jsx("input",{ref:h,type:"file",accept:"image/*",className:"hidden",onChange:a=>{const s=a.target.files?.[0]||null;e.setFieldValue("image",s),y(!1)}}),t.jsx("button",{type:"button",onClick:()=>{h.current?.click(),y(!1)},className:"px-8 py-3 rounded-lg font-estedad-medium bg-purple-500/60 text-white hover:bg-purple-600/60 transition-colors",children:"انتخاب فایل"}),e.values.image instanceof File&&t.jsx("span",{className:"text-sm text-dark font-estedad-light",children:e.values.image.name}),d&&t.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-center",children:[t.jsx("img",{src:q(r.image),alt:r.name||"تصویر کلینیک",className:"w-24 h-24 rounded-lg object-cover"}),t.jsx("span",{className:"text-sm text-paragray",children:"تصویر فعلی"}),t.jsx("button",{type:"button",onClick:()=>{fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:347",message:"Remove image button clicked",data:{removeImageBefore:u,clinicId:r?.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),y(!0),e.setFieldValue("image",null),h.current&&(h.current.value=""),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:354",message:"Remove image state set",data:{removeImageAfter:!0,imageValue:e.values.image},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{})},className:"px-4 py-1.5 text-sm rounded-lg font-estedad-medium bg-red-500/60 text-white hover:bg-red-600/60 transition-colors",children:"حذف عکس"})]}),u&&t.jsx("span",{className:"text-sm text-red-500 font-estedad-light",children:"عکس در حال حذف است"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ",children:[t.jsx(b,{labelText:"عرض جغرافیایی (Latitude)",placeholder:"مثال: 35.6892",optional:!0,className:"bg-white",name:"latitude",type:"number",step:"any",value:e.values.latitude===null?"":e.values.latitude?.toString()||"",onChange:a=>{const s=a.target.value;e.setFieldValue("latitude",s===""?null:parseFloat(s))},onBlur:e.handleBlur,errorMessage:e.touched.latitude&&e.errors.latitude?e.errors.latitude:null}),t.jsx(b,{labelText:"طول جغرافیایی (Longitude)",placeholder:"مثال: 51.3890",optional:!0,className:"bg-white",name:"longitude",type:"number",step:"any",value:e.values.longitude===null?"":e.values.longitude?.toString()||"",onChange:a=>{const s=a.target.value;e.setFieldValue("longitude",s===""?null:parseFloat(s))},onBlur:e.handleBlur,errorMessage:e.touched.longitude&&e.errors.longitude?e.errors.longitude:null})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-dark font-estedad-lightbold mb-4 mr-4",children:"روزهای کاری"}),t.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-2  gap-4 ",children:v.map(a=>{const s=e.values.workingHours[a.value]||[],n=()=>{const l=[...s,{start:"08:00",end:"12:00"}],o={...e.values.workingHours,[a.value]:l};e.setFieldValue("workingHours",o)},i=(l,o,m)=>{const f=[...s];f[l]={...f[l],[o]:m};const w={...e.values.workingHours,[a.value]:f};e.setFieldValue("workingHours",w)},c=l=>{const o=s.filter((f,w)=>w!==l),m={...e.values.workingHours,[a.value]:o};e.setFieldValue("workingHours",m)};return t.jsxs("div",{className:"space-y-3 p-4 border-2 border-main-border-color rounded-lg bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("label",{className:"block text-sm font-medium text-dark",children:a.label}),t.jsxs("button",{type:"button",onClick:n,className:"text-primary hover:text-primary/80 text-xs font-estedad-lightbold flex items-center gap-1",children:[t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M8 3V13M3 8H13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),"افزودن بازه"]})]}),s.length===0?t.jsx("div",{className:"text-center py-4 text-paragray text-sm",children:"بازه زمانی انتخاب نشده است"}):t.jsx("div",{className:"space-y-3",children:s.map((l,o)=>t.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-main-border-color",children:[t.jsxs("div",{className:"flex-1 flex flex-wrap items-center gap-2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("label",{className:"block text-xs text-paragray mb-1",children:"از"}),t.jsx("input",{type:"time",value:l.start,onChange:m=>i(o,"start",m.target.value),className:"w-full px-3 py-2 border-2 border-main-border-color rounded-lg text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("label",{className:"block text-xs text-paragray mb-1",children:"تا"}),t.jsx("input",{type:"time",value:l.end,onChange:m=>i(o,"end",m.target.value),min:l.start,className:"w-full px-3 py-2 border-2 border-main-border-color rounded-lg text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]})]}),t.jsx("button",{type:"button",onClick:()=>c(o),className:"text-red-500 hover:text-red-700 p-2 transition-colors",title:"حذف",children:t.jsx("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M5 5L15 15M15 5L5 15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]},o))})]},a.value)})})]}),t.jsx("div",{className:"flex justify-end mt-6",children:t.jsxs("button",{type:"submit",className:"purple-btn flex items-center gap-2",disabled:e.isSubmitting,children:[g?"ویرایش کلینیک":"ایجاد کلینیک",e.isSubmitting&&t.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"})]})})]})}})}export{L as C};
