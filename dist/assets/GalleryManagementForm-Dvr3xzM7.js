import{r as u,j as t}from"./react-core-DkX7OQ4Q.js";import{c as v,f as C,e as S,b as F,a as h,F as T}from"./forms-CxDKTD82.js";import{C as y,h as q,e as G,i as o,s as p}from"./index-DUiqV2No.js";import{b as M,c as Q,d as $}from"./useGallery-DZ_ZI9H9.js";import{b as A}from"./query-x6gLKhnn.js";import{a as D}from"./react-router-CdfMEooj.js";function V({image:s}){const d=u.useRef(null),c=u.useRef(null),[g,m]=u.useState(!1),b=D(),i=A(),{mutateAsync:x}=M(),{mutateAsync:f}=Q(),{mutateAsync:j}=$(),n=!!s?.id,w=u.useMemo(()=>v({title:h().max(200,"عنوان نباید بیشتر از ۲۰۰ کاراکتر باشد"),description:h(),order:F().integer("ترتیب باید عدد صحیح باشد").min(0,"ترتیب نمی‌تواند منفی باشد"),published:S(),galleryImage:C().nullable().test("file-required","تصویر الزامی است",function(e){return n&&!e&&s?.image?!0:e!=null&&e!==""})}),[n]),N=async(e,l)=>{try{if(!n&&!e.galleryImage){o("لطفاً یک تصویر انتخاب کنید");return}if(n&&!e.galleryImage&&!s?.image){o("لطفاً یک تصویر انتخاب کنید");return}const r=new FormData;if(e.title&&r.append("title",e.title),e.description&&r.append("description",e.description),r.append("order",e.order.toString()),r.append("published",e.published.toString()),e.galleryImage&&r.append("galleryImage",e.galleryImage),n&&s?.id){const a=await f({id:s.id,data:r});p("تصویر با موفقیت ویرایش شد"),a?.data?.image&&i.setQueryData(["gallery",s.id],a),i.invalidateQueries({queryKey:["gallery"]}),i.invalidateQueries({queryKey:["gallery",s.id]}),b("/admin/gallery-management")}else{await x(r),p("تصویر با موفقیت آپلود شد"),l(),i.invalidateQueries({queryKey:["gallery"]});const a=document.querySelector(".overflow-auto");a?a.scrollTo({top:0,behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})}setTimeout(()=>{d.current&&(d.current.value="")},0)}catch(r){let a=r?.response?.data?.message||(n?"خطایی در ویرایش تصویر رخ داد":"خطایی در آپلود تصویر رخ داد");(a.includes("galleryImage cannot be null")||a.includes("galleryImage is required")||a.includes("cannot be null"))&&(a="تصویر الزامی است"),o(a)}},I=async e=>{if(!e||e.length===0){o("لطفاً حداقل یک تصویر انتخاب کنید");return}try{m(!0);const l=new FormData;Array.from(e).forEach(a=>{l.append("galleryImages",a)}),l.append("published","true"),await j(l),p(`${e.length} تصویر با موفقیت آپلود شد`),c.current&&(c.current.value=""),i.invalidateQueries({queryKey:["gallery"]});const r=document.querySelector(".overflow-auto");r?r.scrollTo({top:0,behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})}catch(l){const r=l?.response?.data?.message||"خطایی در آپلود تصاویر رخ داد";o(r)}finally{m(!1)}};return t.jsx(T,{initialValues:{title:s?.title||"",description:s?.description||"",order:s?.order??0,published:s?.published??!0,galleryImage:null},validationSchema:w,onSubmit:async(e,{resetForm:l})=>{await N({title:e.title,description:e.description,order:e.order,published:e.published,galleryImage:e.galleryImage},l)},children:e=>{const l=s?.image&&!e.values.galleryImage;return t.jsxs("form",{onSubmit:e.handleSubmit,className:"space-y-4",children:[t.jsx(y,{labelText:"عنوان",placeholder:"عنوان تصویر را وارد کنید",className:"bg-white",optional:!0,...e.getFieldProps("title"),errorMessage:e.touched.title&&e.errors.title?e.errors.title:null}),t.jsx(q,{labelText:"توضیحات",placeholder:"توضیحات تصویر را وارد کنید",optional:!0,rows:4,className:"bg-white",...e.getFieldProps("description"),errorMessage:e.touched.description&&e.errors.description?e.errors.description:null}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(y,{labelText:"ترتیب",placeholder:"ترتیب نمایش را وارد کنید",className:"bg-white",inputType:"number",...e.getFieldProps("order"),errorMessage:e.touched.order&&e.errors.order?e.errors.order:null}),t.jsx("div",{className:"flex items-center gap-4 pt-8",children:t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.values.published,onChange:r=>e.setFieldValue("published",r.target.checked),className:"w-5 h-5 rounded border-2 border-main-border-color text-primary focus:ring-primary"}),t.jsx("span",{className:"text-dark font-estedad-lightbold",children:"منتشر شده"})]})})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-dark font-estedad-lightbold mb-2 ",children:["تصویر ",!n&&t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[t.jsx("input",{ref:d,type:"file",accept:"image/*",className:"hidden ",onChange:r=>{const a=r.target.files?.[0]||null;e.setFieldValue("galleryImage",a)}}),t.jsx("input",{ref:c,type:"file",accept:"image/*",multiple:!0,className:"hidden ",onChange:r=>{I(r.target.files)}}),!n&&t.jsx("button",{type:"button",onClick:()=>{c.current?.click()},disabled:g,className:"px-8 py-3 rounded-lg font-estedad-medium bg-green-500/60 text-white hover:bg-green-600/60 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:g?t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),"در حال آپلود..."]}):"انتخاب گروهی"}),t.jsx("button",{type:"button",onClick:()=>{d.current?.click()},className:"px-8 py-3  rounded-lg  font-estedad-medium bg-purple-500/60 text-white hover:bg-purple-600/60  transition-colors",children:"انتخاب فایل"}),e.values.galleryImage instanceof File&&t.jsx("span",{className:"text-sm text-dark font-estedad-light",children:e.values.galleryImage.name}),l&&t.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-center ",children:[t.jsx("img",{src:G(s.image),alt:s.title||"تصویر گالری",className:"w-12 h-12 rounded-lg object-cover"}),t.jsx("span",{className:"text-sm text-paragray",children:"تصویر فعلی"})]})]}),e.touched.galleryImage&&e.errors.galleryImage&&t.jsx("div",{className:"text-red-500 text-[10px] mr-4 mt-1 min-h-[20px]",children:e.errors.galleryImage}),!n&&t.jsx("p",{className:"text-xs text-paragray mt-2 mr-4",children:'با استفاده از دکمه "انتخاب گروهی" می‌توانید چندین تصویر را همزمان آپلود کنید. هر تصویر به صورت خودکار با عنوان "تصویر شماره [شماره]" و وضعیت منتشر شده ذخیره می‌شود.'})]}),t.jsx("div",{className:"flex justify-end mt-6",children:t.jsxs("button",{type:"submit",className:"purple-btn flex items-center gap-2",disabled:e.isSubmitting,children:[n?"ویرایش تصویر":"آپلود تصویر",e.isSubmitting&&t.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"})]})})]})}})}export{V as G};
