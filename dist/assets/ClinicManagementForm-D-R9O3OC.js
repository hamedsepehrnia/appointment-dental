import{b as R,j as t}from"./query-DkYU0mMV.js";import{c as f,a as x,b as j,d as H,F as A}from"./forms-C2N9TMf6.js";import{c as D,r as C}from"./react-router-BDAfChV3.js";import{aa as P,ab as B,C as b,k as V,h as E,s as I,l as J}from"./index-B2-mEqET.js";const w=[{value:"saturday",label:"شنبه"},{value:"sunday",label:"یکشنبه"},{value:"monday",label:"دوشنبه"},{value:"tuesday",label:"سه‌شنبه"},{value:"wednesday",label:"چهارشنبه"},{value:"thursday",label:"پنج‌شنبه"},{value:"friday",label:"جمعه"}];function $({clinic:i}){const S=D(),p=R(),{mutateAsync:F}=P(),{mutateAsync:T}=B(),h=C.useRef(null),[m,y]=C.useState(!1),g=!!i?.id,M=f({name:x().required("نام کلینیک الزامی است"),address:x().required("آدرس الزامی است"),phoneNumbers:H().of(x().required("شماره تلفن الزامی است")).min(1,"حداقل یک شماره تلفن الزامی است"),description:x(),latitude:j().nullable().min(-90,"عرض جغرافیایی باید بین -90 تا 90 باشد").max(90,"عرض جغرافیایی باید بین -90 تا 90 باشد"),longitude:j().nullable().min(-180,"طول جغرافیایی باید بین -180 تا 180 باشد").max(180,"طول جغرافیایی باید بین -180 تا 180 باشد"),workingHours:f(),eitaaChatId:x().nullable()}),O=async(e,l)=>{try{const s=new FormData;s.append("name",e.name),s.append("address",e.address);const a=e.phoneNumbers.filter(n=>n&&n.trim()!=="");if(s.append("phoneNumber",JSON.stringify(a)),e.description&&s.append("description",e.description),e.latitude!==null&&e.latitude!==void 0&&!isNaN(e.latitude)&&s.append("latitude",e.latitude.toString()),e.longitude!==null&&e.longitude!==void 0&&!isNaN(e.longitude)&&s.append("longitude",e.longitude.toString()),e.workingHours){const n={};w.forEach(d=>{const o=e.workingHours[d.value]||[];if(o.length>0){const c=o.filter(u=>u.start&&u.end).map(u=>`${u.start}-${u.end}`);n[d.value]=c.length>0?c.join(" & "):null}else n[d.value]=null}),s.append("workingHours",JSON.stringify(n))}const r=e.eitaaChatId||"";console.log("=== FRONTEND DEBUG - eitaaChatId ==="),console.log("values.eitaaChatId:",e.eitaaChatId),console.log("eitaaChatIdValue to send:",r),console.log("isEditMode:",g),s.append("eitaaChatId",r),console.log("=== FormData entries ===");for(const[n,d]of s.entries())console.log(`${n}:`,d);if(console.log("========================"),e.image instanceof File&&s.append("image",e.image),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:122",message:"Before adding removeImage to FormData",data:{removeImage:m,isEditMode:g,hasImageFile:e.image instanceof File},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{}),m&&g&&(s.append("removeImage","true"),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:125",message:"removeImage added to FormData",data:{removeImage:m,isEditMode:g},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{})),g&&i?.id){fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:127",message:"Before updateClinic call",data:{clinicId:i.id,removeImage:m,hasImageFile:s.has("image"),hasRemoveImage:s.has("removeImage")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});let n;try{n=await T({id:i.id,data:s}),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:130",message:"After updateClinic response - SUCCESS",data:{clinicId:i.id,responseImage:n?.data?.clinic?.image,responseImageNull:n?.data?.clinic?.image===null,responseImageUndefined:n?.data?.clinic?.image===void 0,fullResponse:JSON.stringify(n)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{})}catch(d){const o=d;throw fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:155",message:"After updateClinic response - ERROR",data:{clinicId:i.id,error:o?.message,errorResponse:o?.response?.data},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),d}I("کلینیک با موفقیت ویرایش شد"),y(!1),n?.data?.clinic&&(p.setQueryData(["clinic",i.id],n),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:135",message:"Cache updated with response",data:{clinicId:i.id,cachedImage:n?.data?.clinic?.image},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})),await p.invalidateQueries({queryKey:["clinics"],refetchType:"active"}),await p.invalidateQueries({queryKey:["clinic",i.id],refetchType:"active"}),await p.refetchQueries({queryKey:["clinics"]}),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:139",message:"Queries invalidated",data:{clinicId:i.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),S("/admin/clinics-management")}else{await F(s),I("کلینیک با موفقیت ایجاد شد"),l(),h.current&&(h.current.value=""),p.invalidateQueries({queryKey:["clinics"]}),p.invalidateQueries({queryKey:["clinic"]});const n=document.querySelector(".overflow-auto");n?n.scrollTo({top:0,behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})}}catch(s){const a=s?.response?.data?.message||(g?"خطایی در ویرایش کلینیک رخ داد":"خطایی در ایجاد کلینیک رخ داد");J(a)}};return t.jsx(A,{initialValues:{name:i?.name||"",address:i?.address||"",phoneNumbers:(l=>{if(!l)return[""];if(Array.isArray(l))return l.length>0?l:[""];if(typeof l=="string"){const s=l.trim();if(s.startsWith("[")&&s.endsWith("]"))try{const a=JSON.parse(s);if(Array.isArray(a))return a.length>0?a.filter(r=>r&&String(r).trim()).map(r=>String(r).trim()):[""]}catch{}if(s.includes(",")||s.includes("|")||s.includes(";")){const a=s.split(/[,|;]/).map(r=>r.trim()).filter(r=>r);return a.length>0?a:[""]}return s?[s]:[""]}return[""]})(i?.phoneNumber),description:i?.description||"",image:null,latitude:i?.latitude??null,longitude:i?.longitude??null,eitaaChatId:i?.eitaaChatId||null,workingHours:(()=>{const e=i?.workingHours;if(e){const l={};return w.forEach(s=>{const a=e[s.value];if(a==null)l[s.value]=[];else if(typeof a=="string"&&a.trim())if(a.includes(" & ")){const r=a.split(" & ").map(n=>{const[d,o]=n.trim().split("-");return{start:d||"",end:o||""}});l[s.value]=r.filter(n=>n.start&&n.end)}else{const[r,n]=a.split("-");l[s.value]=r&&n?[{start:r.trim(),end:n.trim()}]:[]}else Array.isArray(a)?l[s.value]=a.map(r=>{if(typeof r=="string"){const[n,d]=r.split("-");return{start:n||"",end:d||""}}return r}):l[s.value]=[]}),l}return{}})()},validationSchema:M,onSubmit:async(e,{resetForm:l})=>{await O({name:e.name,address:e.address,phoneNumbers:e.phoneNumbers,description:e.description,image:e.image,latitude:e.latitude===null||e.latitude===void 0?null:Number(e.latitude),longitude:e.longitude===null||e.longitude===void 0?null:Number(e.longitude),workingHours:e.workingHours,eitaaChatId:e.eitaaChatId||null},l)},children:e=>{const l=i?.image&&!e.values.image&&!m;return t.jsxs("form",{onSubmit:e.handleSubmit,className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ",children:[t.jsx(b,{labelText:"نام کلینیک",placeholder:"نام کلینیک را وارد کنید",className:"bg-white",requiredText:!0,...e.getFieldProps("name"),errorMessage:e.touched.name&&e.errors.name?e.errors.name:null}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"block text-dark font-estedad-lightbold mb-2 mr-4",children:["شماره تماس ",t.jsx("span",{className:"text-red-500",children:"*"})]}),e.values.phoneNumbers.map((s,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(b,{placeholder:"شماره تماس را وارد کنید",className:"bg-white flex-1",value:s,onChange:r=>{const n=[...e.values.phoneNumbers];n[a]=r.target.value,e.setFieldValue("phoneNumbers",n)},onBlur:()=>e.setFieldTouched(`phoneNumbers.${a}`,!0),inputType:"phone",errorMessage:Array.isArray(e.touched.phoneNumbers)&&e.touched.phoneNumbers[a]&&Array.isArray(e.errors.phoneNumbers)&&e.errors.phoneNumbers[a]?String(e.errors.phoneNumbers[a]):null}),e.values.phoneNumbers.length>1&&t.jsx("button",{type:"button",onClick:()=>{const r=e.values.phoneNumbers.filter((n,d)=>d!==a);e.setFieldValue("phoneNumbers",r)},className:"px-4 py-2 text-red-500 hover:text-red-700 transition-colors",title:"حذف",children:t.jsx("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M5 5L15 15M15 5L5 15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]},a)),t.jsxs("button",{type:"button",onClick:()=>{e.setFieldValue("phoneNumbers",[...e.values.phoneNumbers,""])},className:"text-primary hover:text-primary/80 text-sm font-estedad-lightbold flex items-center gap-1",children:[t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M8 3V13M3 8H13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),"افزودن شماره تماس"]}),e.touched.phoneNumbers&&e.errors.phoneNumbers&&typeof e.errors.phoneNumbers=="string"&&t.jsx("div",{className:"text-red-500 text-sm",children:e.errors.phoneNumbers})]})]}),t.jsx(b,{labelText:"آدرس",placeholder:"آدرس کلینیک را وارد کنید",requiredText:!0,className:"bg-white",...e.getFieldProps("address"),errorMessage:e.touched.address&&e.errors.address?e.errors.address:null}),t.jsx(V,{labelText:"توضیحات",placeholder:"توضیحات کلینیک را وارد کنید",optional:!0,rows:4,className:"bg-white",...e.getFieldProps("description"),errorMessage:e.touched.description&&e.errors.description?e.errors.description:null}),t.jsxs("div",{className:"bg-blue-50 rounded-lg border border-blue-200 p-4",children:[t.jsxs("h6",{className:"text-md font-estedad-semibold text-dark mb-3",children:[t.jsx("i",{className:"fas fa-paper-plane ml-2"}),"تنظیمات ایتا"]}),t.jsx("p",{className:"text-xs text-gray-600 mb-3 font-estedad-light",children:"شناسه کانال/گروه ایتا برای ارسال نوتیفیکیشن نوبت‌های این کلینیک"}),t.jsx(b,{labelText:"شناسه کانال/گروه ایتا",placeholder:"مثال: 1404 یا eitaayar",optional:!0,className:"bg-white",...e.getFieldProps("eitaaChatId"),errorMessage:e.touched.eitaaChatId&&e.errors.eitaaChatId?e.errors.eitaaChatId:null})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-dark font-estedad-lightbold mb-2 mr-4",children:"تصویر کلینیک"}),t.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[t.jsx("input",{ref:h,type:"file",accept:"image/*",className:"hidden",onChange:s=>{const a=s.target.files?.[0]||null;e.setFieldValue("image",a),y(!1)}}),t.jsx("button",{type:"button",onClick:()=>{h.current?.click(),y(!1)},className:"px-8 py-3 rounded-lg font-estedad-medium bg-purple-500/60 text-white hover:bg-purple-600/60 transition-colors",children:"انتخاب فایل"}),e.values.image instanceof File&&t.jsx("span",{className:"text-sm text-dark font-estedad-light",children:e.values.image.name}),l&&t.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-center",children:[t.jsx("img",{src:E(i.image),alt:i.name||"تصویر کلینیک",className:"w-24 h-24 rounded-lg object-cover"}),t.jsx("span",{className:"text-sm text-paragray",children:"تصویر فعلی"}),t.jsx("button",{type:"button",onClick:()=>{fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:347",message:"Remove image button clicked",data:{removeImageBefore:m,clinicId:i?.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),y(!0),e.setFieldValue("image",null),h.current&&(h.current.value=""),fetch("http://127.0.0.1:7242/ingest/c5282bb0-1a44-499c-bce8-9a51f667292e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"ClinicManagementForm.tsx:354",message:"Remove image state set",data:{removeImageAfter:!0,imageValue:e.values.image},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{})},className:"px-4 py-1.5 text-sm rounded-lg font-estedad-medium bg-red-500/60 text-white hover:bg-red-600/60 transition-colors",children:"حذف عکس"})]}),m&&t.jsx("span",{className:"text-sm text-red-500 font-estedad-light",children:"عکس در حال حذف است"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ",children:[t.jsx(b,{labelText:"عرض جغرافیایی (Latitude)",placeholder:"مثال: 35.6892",optional:!0,className:"bg-white",name:"latitude",type:"number",step:"any",value:e.values.latitude===null?"":e.values.latitude?.toString()||"",onChange:s=>{const a=s.target.value;e.setFieldValue("latitude",a===""?null:parseFloat(a))},onBlur:e.handleBlur,errorMessage:e.touched.latitude&&e.errors.latitude?e.errors.latitude:null}),t.jsx(b,{labelText:"طول جغرافیایی (Longitude)",placeholder:"مثال: 51.3890",optional:!0,className:"bg-white",name:"longitude",type:"number",step:"any",value:e.values.longitude===null?"":e.values.longitude?.toString()||"",onChange:s=>{const a=s.target.value;e.setFieldValue("longitude",a===""?null:parseFloat(a))},onBlur:e.handleBlur,errorMessage:e.touched.longitude&&e.errors.longitude?e.errors.longitude:null})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-dark font-estedad-lightbold mb-4 mr-4",children:"روزهای کاری"}),t.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-2  gap-4 ",children:w.map(s=>{const a=e.values.workingHours[s.value]||[],r=()=>{const o=[...a,{start:"08:00",end:"12:00"}],c={...e.values.workingHours,[s.value]:o};e.setFieldValue("workingHours",c)},n=(o,c,u)=>{const N=[...a];N[o]={...N[o],[c]:u};const v={...e.values.workingHours,[s.value]:N};e.setFieldValue("workingHours",v)},d=o=>{const c=a.filter((N,v)=>v!==o),u={...e.values.workingHours,[s.value]:c};e.setFieldValue("workingHours",u)};return t.jsxs("div",{className:"space-y-3 p-4 border-2 border-main-border-color rounded-lg bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("label",{className:"block text-sm font-medium text-dark",children:s.label}),t.jsxs("button",{type:"button",onClick:r,className:"text-primary hover:text-primary/80 text-xs font-estedad-lightbold flex items-center gap-1",children:[t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M8 3V13M3 8H13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),"افزودن بازه"]})]}),a.length===0?t.jsx("div",{className:"text-center py-4 text-paragray text-sm",children:"بازه زمانی انتخاب نشده است"}):t.jsx("div",{className:"space-y-3",children:a.map((o,c)=>t.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-main-border-color",children:[t.jsxs("div",{className:"flex-1 flex flex-wrap items-center gap-2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("label",{className:"block text-xs text-paragray mb-1",children:"از"}),t.jsx("input",{type:"time",value:o.start,onChange:u=>n(c,"start",u.target.value),className:"w-full px-3 py-2 border-2 border-main-border-color rounded-lg text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("label",{className:"block text-xs text-paragray mb-1",children:"تا"}),t.jsx("input",{type:"time",value:o.end,onChange:u=>n(c,"end",u.target.value),min:o.start,className:"w-full px-3 py-2 border-2 border-main-border-color rounded-lg text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]})]}),t.jsx("button",{type:"button",onClick:()=>d(c),className:"text-red-500 hover:text-red-700 p-2 transition-colors",title:"حذف",children:t.jsx("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M5 5L15 15M15 5L5 15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]},c))})]},s.value)})})]}),t.jsx("div",{className:"flex justify-end mt-6",children:t.jsxs("button",{type:"submit",className:"purple-btn flex items-center gap-2",disabled:e.isSubmitting,children:[g?"ویرایش کلینیک":"ایجاد کلینیک",e.isSubmitting&&t.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"})]})})]})}})}export{$ as C};
